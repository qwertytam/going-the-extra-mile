<!DOCTYPE html>
<html>
<head>
    <title>Directions Service</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
    src="https://maps.googleapis.com/maps/api/js?key=APIKEY&callback=initMap&libraries=&v=weekly"
    defer
    ></script>
    <style type="text/css">
    #msgs {
        font-family: "Roboto", "sans-serif";
        line-height: 30px;
        padding-left: 10px;
        padding-right: 10px;
        padding-bottom: 10px;
        padding-top: 10px;
    }

    #msgs i {
        font-size: 12px;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    /* Always set the map height explicitly to define the size of the div
    * element that contains the map. */
    #map {
        height: 70%;
        width: 100%;
    }

    #msgs {
        margin: 20px;
        border-width: 2px;
        width: 100%;
        height: 100px;
        float: left;
        text-align: left;
        padding-top: 0;
    }

    </style>
    <script>
    // Delay time in milliseconds
    var delay = 100;
    var subset = 0;
    var routes_list = []
    var optRoute = [
        {location: {lat: 40.6501, lng: -73.94958}},
        {location: {lat: 41.1476, lng: -73.98931}},
        {location: {lat: 40.78343, lng: -73.96625}},
        {location: {lat: 40.79677, lng: -74.48154}},
        {location: {lat: 40.82982, lng: -75.07767}},
        {location: {lat: 41.32232, lng: -74.80239}},
        {location: {lat: 41.57676, lng: -75.25879}},
        {location: {lat: 41.65565, lng: -74.68933}},
        {location: {lat: 42.27814, lng: -74.91599}},
        {location: {lat: 42.53118, lng: -75.52351}},
        {location: {lat: 42.60118, lng: -76.18048}},
        {location: {lat: 43.04812, lng: -76.14742}},
        {location: {lat: 43.07535, lng: -75.70685}},
        {location: {lat: 43.02563, lng: -74.98599}},
        {location: {lat: 42.70048, lng: -74.92426}},
        {location: {lat: 43.1009, lng: -75.23266}},
        {location: {lat: 42.81424, lng: -73.93957}},
        {location: {lat: 42.95452, lng: -74.37652}},
        {location: {lat: 43.4709, lng: -74.41265}},
        {location: {lat: 43.37729, lng: -73.61317}},
        {location: {lat: 43.26702, lng: -73.58456}},
        {location: {lat: 42.72841, lng: -73.69179}},
        {location: {lat: 43.00091, lng: -73.84901}},
        {location: {lat: 42.66591, lng: -74.30958}},
        {location: {lat: 43.00674, lng: -74.36764}},
        {location: {lat: 42.60018, lng: -73.97356}},
        {location: {lat: 41.92704, lng: -73.99736}},
        {location: {lat: 42.25286, lng: -73.79096}},
        {location: {lat: 42.21731, lng: -73.86457}},
        {location: {lat: 41.70037, lng: -73.92097}},
        {location: {lat: 41.40204, lng: -74.32432}},
        {location: {lat: 41.43009, lng: -73.68013}},
        {location: {lat: 40.88593, lng: -74.04347}},
        {location: {lat: 40.91677, lng: -74.17181}},
        {location: {lat: 40.84985, lng: -73.86641}},
        {location: {lat: 40.73566, lng: -74.17237}},
        {location: {lat: 40.72816, lng: -74.07764}},
        {location: {lat: 40.74927, lng: -73.64068}},
        {location: {lat: 41.22496, lng: -73.3712}},
        {location: {lat: 41.34882, lng: -72.89986}},
        {location: {lat: 40.91704, lng: -72.66204}},
        {location: {lat: 41.43538, lng: -72.52312}},
        {location: {lat: 42.13511, lng: -72.63162}},
        {location: {lat: 41.80642, lng: -72.73284}},
        {location: {lat: 41.79249, lng: -73.24532}},
        {location: {lat: 42.37067, lng: -73.2064}},
        {location: {lat: 43.03546, lng: -73.09295}},
        {location: {lat: 42.58312, lng: -72.59187}},
        {location: {lat: 42.34014, lng: -72.66377}},
        {location: {lat: 41.83003, lng: -71.98749}},
        {location: {lat: 41.85501, lng: -72.33649}},
        {location: {lat: 42.26259, lng: -71.80229}},
        {location: {lat: 41.87136, lng: -71.5786}},
        {location: {lat: 41.67334, lng: -71.57895}},
        {location: {lat: 41.46678, lng: -72.1065}},
        {location: {lat: 41.39649, lng: -71.61966}},
        {location: {lat: 41.4998, lng: -71.281}},
        {location: {lat: 41.38901, lng: -70.51336}},
        {location: {lat: 41.28346, lng: -70.09946}},
        {location: {lat: 41.70011, lng: -70.29947}},
        {location: {lat: 41.70554, lng: -71.28612}},
        {location: {lat: 42.24177, lng: -71.16616}},
        {location: {lat: 41.9001, lng: -71.08977}},
        {location: {lat: 42.3555, lng: -71.06575}},
        {location: {lat: 41.98743, lng: -70.73707}},
        {location: {lat: 42.48555, lng: -71.39184}},
        {location: {lat: 42.63887, lng: -70.86792}},
        {location: {lat: 43.19786, lng: -70.87367}},
        {location: {lat: 42.9787, lng: -71.07284}},
        {location: {lat: 43.47647, lng: -70.71839}},
        {location: {lat: 43.65737, lng: -70.2589}},
        {location: {lat: 44.09785, lng: -70.23117}},
        {location: {lat: 44.00286, lng: -69.6656}},
        {location: {lat: 44.10369, lng: -69.10893}},
        {location: {lat: 44.42591, lng: -69.00642}},
        {location: {lat: 44.54341, lng: -68.41946}},
        {location: {lat: 44.71508, lng: -67.46138}},
        {location: {lat: 46.12616, lng: -67.8403}},
        {location: {lat: 45.83736, lng: -69.28452}},
        {location: {lat: 44.80118, lng: -68.77781}},
        {location: {lat: 44.76506, lng: -69.71922}},
        {location: {lat: 44.67062, lng: -70.15117}},
        {location: {lat: 44.40916, lng: -69.76726}},
        {location: {lat: 43.91064, lng: -69.8206}},
        {location: {lat: 44.25979, lng: -70.50062}},
        {location: {lat: 43.68536, lng: -71.11673}},
        {location: {lat: 44.09034, lng: -72.02648}},
        {location: {lat: 43.52785, lng: -71.47035}},
        {location: {lat: 43.29765, lng: -71.68019}},
        {location: {lat: 42.91531, lng: -71.71601}},
        {location: {lat: 43.36535, lng: -72.17342}},
        {location: {lat: 42.93369, lng: -72.27814}},
        {location: {lat: 42.98564, lng: -72.65593}},
        {location: {lat: 43.62424, lng: -72.51843}},
        {location: {lat: 44.01553, lng: -73.16937}},
        {location: {lat: 43.61062, lng: -72.97261}},
        {location: {lat: 44.21616, lng: -73.59097}},
        {location: {lat: 44.47588, lng: -73.21207}},
        {location: {lat: 44.59394, lng: -72.61651}},
        {location: {lat: 44.27342, lng: -72.6149}},
        {location: {lat: 43.98979, lng: -72.4476}},
        {location: {lat: 44.41922, lng: -72.01509}},
        {location: {lat: 44.48895, lng: -71.56925}},
        {location: {lat: 44.56506, lng: -71.55981}},
        {location: {lat: 44.93644, lng: -72.2051}},
        {location: {lat: 44.81088, lng: -73.08319}},
        {location: {lat: 44.83125, lng: -73.27323}},
        {location: {lat: 44.69949, lng: -73.45291}},
        {location: {lat: 44.84866, lng: -74.2949}},
        {location: {lat: 44.59562, lng: -75.16909}},
        {location: {lat: 43.78674, lng: -75.49185}},
        {location: {lat: 43.97478, lng: -75.91076}},
        {location: {lat: 43.45535, lng: -76.5105}},
        {location: {lat: 42.93173, lng: -76.56605}},
        {location: {lat: 42.90479, lng: -76.86274}},
        {location: {lat: 42.87423, lng: -77.28804}},
        {location: {lat: 42.99812, lng: -78.18752}},
        {location: {lat: 42.88645, lng: -78.87837}},
        {location: {lat: 43.17061, lng: -78.69031}},
        {location: {lat: 43.24645, lng: -78.19363}},
        {location: {lat: 42.7959, lng: -77.81695}},
        {location: {lat: 42.74006, lng: -78.13279}},
        {location: {lat: 43.15478, lng: -77.61556}},
        {location: {lat: 43.06423, lng: -76.99025}},
        {location: {lat: 42.6609, lng: -77.05386}},
        {location: {lat: 42.44063, lng: -76.49661}},
        {location: {lat: 42.38063, lng: -76.87329}},
        {location: {lat: 42.33702, lng: -77.31776}},
        {location: {lat: 41.74868, lng: -77.30053}},
        {location: {lat: 42.0898, lng: -76.80773}},
        {location: {lat: 41.76758, lng: -76.44272}},
        {location: {lat: 41.83397, lng: -75.87714}},
        {location: {lat: 42.10341, lng: -76.26215}},
        {location: {lat: 42.09869, lng: -75.91797}},
        {location: {lat: 41.53869, lng: -75.94659}},
        {location: {lat: 41.40916, lng: -75.6649}},
        {location: {lat: 40.87592, lng: -75.73241}},
        {location: {lat: 40.68565, lng: -76.1955}},
        {location: {lat: 41.0037, lng: -76.45495}},
        {location: {lat: 41.17701, lng: -75.98903}},
        {location: {lat: 41.42397, lng: -76.49411}},
        {location: {lat: 40.96342, lng: -76.61273}},
        {location: {lat: 41.24119, lng: -77.00108}},
        {location: {lat: 40.78592, lng: -77.0472}},
        {location: {lat: 40.86259, lng: -76.79441}},
        {location: {lat: 40.96453, lng: -76.88441}},
        {location: {lat: 41.13701, lng: -77.44693}},
        {location: {lat: 40.91339, lng: -77.77833}},
        {location: {lat: 41.51145, lng: -78.23529}},
        {location: {lat: 41.77479, lng: -78.02056}},
        {location: {lat: 42.22312, lng: -78.03445}},
        {location: {lat: 41.81117, lng: -78.44474}},
        {location: {lat: 41.84395, lng: -79.14504}},
        {location: {lat: 42.25256, lng: -78.80559}},
        {location: {lat: 42.25395, lng: -79.50449}},
        {location: {lat: 42.12922, lng: -80.08506}},
        {location: {lat: 41.64144, lng: -80.15145}},
        {location: {lat: 41.61422, lng: -81.14899}},
        {location: {lat: 41.73867, lng: -80.76981}},
    ];

    function initMap() {
        const directionsService = new google.maps.DirectionsService();
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 4,
            center: { lat: 41.85, lng: -87.65 },
            noClear: true,
        });
        createRoutes(directionsService, optRoute)
        for (i = 0; i < routes_list.length; i++) {
            routes_list[i].setOptions({
                suppressMarkers: true,
                preserveViewport: true,
            });
            routes_list[i].setMap(map);
        }
    }

    function calcRoute(dService, start, end, routes) {
        const directionsDisplay = new google.maps.DirectionsRenderer();
        var waypts = [];
        for (var i = 0; i < routes.length; i++) {
            waypts.push({
                location: routes[i],
                stopover: false});
            }
        var request = {
            origin: start,
            destination: end,
            waypoints: waypts,
            optimizeWaypoints: false,
            travelMode: google.maps.TravelMode.DRIVING
        };
        dService.route(request, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
                var today = new Date();
                var hours = today.getHours();
                var minutes = today.getMinutes();
                var mseconds = today.getMilliseconds();
                var time = hours + ':' + minutes + ':' + mseconds;
                var msg = ' status ' + status + ' time ' + time + '<br>';
                document.getElementById('msgs').innerHTML += msg;
            }
            else {
                if (status == google.maps.DirectionsStatus.OVER_QUERY_LIMIT) {
                    delay = delay + 100;
                    subset = subset - (batchLength - 1);
                    var msg = 'New delay of ' + delay + ' ms with subset now ' + subset + ' time ' + time + '<br>';
                    document.getElementById('msgs').innerHTML += msg;
                    console.warn(status);
                } else {
                    var msg = 'Directions request failed due to: ' + status + '<br>';
                    document.getElementById('msgs').innerHTML += msg;
                }
            }
        });
        routes_list.push(directionsDisplay);
    }

    function createRoutes(dirService, route) {
        var batchLength = 10;
        route.push(route[0]);
        while (subset < route.length) {
            var endIdx = Math.min(subset + batchLength, route.length - 1);
            var waypointSubset = route.slice(subset, endIdx);
            var startPoint = waypointSubset[0];
            var midPoints = waypointSubset.slice(1, waypointSubset.length - 1);
            var endPoint = waypointSubset[waypointSubset.length - 1];
            // calcRoute(dirService, startPoint, endPoint, midPoints);
            setTimeout('calcRoute("'+dirService+'","'+startPoint+'","'+endPoint+'","'+midPoints+'")', delay);
            subset += (batchLength - 1);

            routeLength = midPoints.length;
            var today = new Date();
            var hours = today.getHours();
            var minutes = today.getMinutes();
            var mseconds = today.getMilliseconds();
            var time = hours + ':' + minutes + ':' + mseconds;
            var startCoords = ' lat: ' + startPoint.location.lat + ' lon: ' + startPoint.location.lng;
            var endCoords = ' lat: ' + endPoint.location.lat + ' lon: ' + endPoint.location.lng;
            var msg = 'Subset: ' + subset + ' start ' + startCoords + ' end ' + endCoords + ' delay ' + delay + 'ms time' + time + '<br>';
            document.getElementById('msgs').innerHTML += msg;
        }
    }

    </script>
    </head>
    <body>
        <div id="map"></div>
        <div id="msgs"></div>
    </body>
    </html>
